<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, serverTimestamp,
    collection, query, where, orderBy, limit, getDocs,
    updateDoc, addDoc
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCfragjh50KQRj5G6jm7fZdR2bI2NoQsdk",
    authDomain: "pakbet-b0abe.firebaseapp.com",
    projectId: "pakbet-b0abe",
    storageBucket: "pakbet-b0abe.appspot.com",
    messagingSenderId: "499452911724",
    appId: "1:499452911724:web:7b0e314d16dce8a6dcb849",
    measurementId: "G-QPLND82T33"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const depositBtn = document.getElementById('depositBtn');
  const depositInput = document.getElementById('deposit-amount');
  const depositMethod = document.getElementById('deposit-method');
  const statusMsg = document.getElementById('statusMessage');

  // Generate Unique Reference
  function generateReference() {
    return 'PAK-' + Math.random().toString(36).substring(2, 10).toUpperCase();
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = 'auth.html';

    depositBtn.addEventListener('click', async () => {
      const amount = parseFloat(depositInput.value);
      const method = depositMethod.value;

      if (isNaN(amount) || amount <= 0) {
        statusMsg.textContent = 'Please enter a valid amount in Rands.';
        return;
      }

      const reference = generateReference();
      const uid = user.uid;

      let paymentData = {
        uid: uid,
        amount: amount,
        method: method,
        status: "pending",
        reference: reference,
        timestamp: serverTimestamp()
      };

      if (method === 'shop2shop') {
        // Redirect user to Shop2Shop payment page
        window.open('https://shop.shoptoshop.co.za/qr-code/send?code=IZVGIL', '_blank');
        statusMsg.textContent = 'Complete your payment at Shop2Shop. Then wait for admin to confirm.';
      } else if (method === 'voucher' || method === 'flashvoucher') {
        const voucherCode = prompt(`Enter your ${method === 'voucher' ? 'Voucher' : 'Flash Voucher'} 16-digit code:`);
        if (!voucherCode || voucherCode.length !== 16) {
          statusMsg.textContent = 'Invalid Voucher Code.';
          return;
        }
        paymentData.voucherCode = voucherCode;
        await addDoc(collection(db, 'pending_deposits'), paymentData);
        statusMsg.textContent = `Voucher submitted! Reference: ${reference}. Awaiting admin approval.`;
      } else if (method === 'manual') {
        const accName = prompt("Account Holder Name:");
        const bankName = prompt("Bank Name:");
        const accNum = prompt("Account Number:");
        const ref = prompt("Reference Used for Bank Transfer:");
        if (!accName || !bankName || !accNum || !ref) {
          statusMsg.textContent = 'All bank details are required.';
          return;
        }
        paymentData.bankDetails = { accName, bankName, accNum, userReference: ref };
        await addDoc(collection(db, 'pending_deposits'), paymentData);
        statusMsg.textContent = `Bank deposit logged! Reference: ${reference}. Awaiting admin verification.`;
      } else {
        statusMsg.textContent = 'Invalid deposit method.';
      }
    });
  });
</script>
