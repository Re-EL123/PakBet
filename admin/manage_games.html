<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PakBet — Manage Fixtures</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in { ... }
    .spinner { ... }
    /* Modal backdrop */
    .modal-bg { background: rgba(0,0,0,0.6); }
  </style>
</head>
<body class="bg-gray-900 text-white flex flex-col min-h-screen">

  <nav> ... </nav>

  <main class="...">
    <h1 class="text-4xl font-extrabold mb-6">Manage Fixtures</h1>

    <!-- Fixture Form -->
    <div class="bg-gray-800 p-6 rounded-xl mb-12">
      <h2 id="formTitle" class="text-2xl font-bold mb-4">Add New Fixture</h2>
      <form id="fixtureForm" class="space-y-4">
        <select id="gameType" ...> ... </select>
        <input id="homeTeam" type="text" ... />
        <input id="awayTeam" type="text" ... />
        <input id="league" type="text" ... />
        <input id="fixtureDate" type="datetime-local" ... />
        <div class="flex space-x-2">
          <input id="oddsHome" ... />
          <input id="oddsDraw" ... />
          <input id="oddsAway" ... />
        </div>
        <select id="result" class="w-full p-2 rounded bg-gray-700 text-white">
          <option value="">-- Result (optional) --</option>
          <option value="home">Home Win</option>
          <option value="draw">Draw</option>
          <option value="away">Away Win</option>
        </select>
        <button type="submit" id="submitBtn" class="bg-green-500 px-4 py-2 rounded font-bold hover:bg-green-600">Add Fixture</button>
        <button type="button" id="cancelEditBtn" class="hidden bg-gray-600 px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
      </form>
    </div>

    <!-- Filters -->
    <div class="..."> ... </div>

    <!-- Fixtures List -->
    <div id="fixturesList" class="...">
      <div class="spinner mx-auto"></div>
    </div>
  </main>

  <!-- Confirm Modal -->
  <div id="confirmModal" class="fixed inset-0 hidden justify-center items-center modal-bg">
    <div class="bg-gray-800 p-6 rounded-xl space-y-4 w-full max-w-md">
      <p id="confirmText" class="text-lg"></p>
      <div class="flex justify-end space-x-4">
        <button id="confirmCancel" class="bg-gray-600 px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
        <button id="confirmOK" class="bg-red-500 px-4 py-2 rounded hover:bg-red-600">Yes, Save</button>
      </div>
    </div>
  </div>

  <footer> ... </footer>

  <script type="module">
    import { initializeApp } from "...";
    import { getAuth, onAuthStateChanged, signOut } from "...";
    import { getFirestore, doc, getDoc, addDoc, updateDoc, deleteDoc, getDocs, query, orderBy, collection, serverTimestamp } from "...";

    const app = initializeApp({ ... });
    const auth = getAuth(app);
    const db = getFirestore(app);

    let adminUid = '';
    let allFixtures = [];
    let editId = null;

    const form = document.getElementById('fixtureForm');
    const formTitle = document.getElementById('formTitle');
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelEditBtn');
    const modal = document.getElementById('confirmModal');
    const confirmText = document.getElementById('confirmText');
    let modalResolve;

    function showConfirm(message) {
      confirmText.textContent = message;
      modal.classList.remove('hidden');
      return new Promise(resolve => {
        modalResolve = resolve;
      });
    }
    document.getElementById('confirmCancel').onclick = () => { modal.classList.add('hidden'); modalResolve(false); };
    document.getElementById('confirmOK').onclick = () => { modal.classList.add('hidden'); modalResolve(true); };

    function resetForm() {
      form.reset();
      editId = null;
      formTitle.textContent = 'Add New Fixture';
      submitBtn.textContent = 'Add Fixture';
      cancelBtn.classList.add('hidden');
    }

    async function handleSave() {
      const type = gameType.value;
      const home = homeTeam.value.trim();
      const away = awayTeam.value.trim();
      const leagueVal = league.value.trim();
      const dateTs = { seconds: Math.floor(new Date(fixtureDate.value).getTime() / 1000) };
      const oddsData = {
        home: parseFloat(oddsHome.value),
        draw: parseFloat(oddsDraw.value),
        away: parseFloat(oddsAway.value)
      };
      const resultVal = result.value;

      if (editId) {
        await updateDoc(doc(db,'fixtures',editId), {
          type, home, away, league: leagueVal, date: dateTs, odds: oddsData,
          result: resultVal||null, updatedBy: adminUid, updatedAt: serverTimestamp()
        });
      } else {
        await addDoc(collection(db,'fixtures'), {
          type, home, away, league: leagueVal, date: dateTs, odds: oddsData,
          result: resultVal||null, createdBy: adminUid, createdAt: serverTimestamp()
        });
      }
      resetForm();
      loadFixtures();
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const action = editId ? 'update this fixture' : 'add new fixture';
      const ok = await showConfirm(`Are you sure you want to ${action}?`);
      if (ok) await handleSave();
    });

    cancelBtn.addEventListener('click', resetForm);

    async function startEdit(f) {
      editId = f.id;
      formTitle.textContent = 'Edit Fixture';
      submitBtn.textContent = 'Save Changes';
      cancelBtn.classList.remove('hidden');

      gameType.value = f.type;
      homeTeam.value = f.home;
      awayTeam.value = f.away;
      league.value = f.league;
      fixtureDate.value = new Date(f.date.seconds * 1000).toISOString().slice(0,16);
      oddsHome.value = f.odds.home;
      oddsDraw.value = f.odds.draw;
      oddsAway.value = f.odds.away;
      result.value = f.result || '';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function deleteFixture(id) {
      if (confirm('Delete this fixture?')) {
        await deleteDoc(doc(db,'fixtures',id));
        loadFixtures();
      }
    }

    function renderFixtures() {
      fixturesList.innerHTML = '';
      const filter = filterType.value;
      const term = searchBox.value.toLowerCase();
      const data = allFixtures
        .filter(f => (!filter || f.type===filter) && (`${f.home} ${f.away} ${f.league}`.toLowerCase().includes(term)))
        .sort((a,b)=>a.date.seconds - b.date.seconds);

      if (!data.length) {
        fixturesList.innerHTML = '<p>No fixtures found.</p>';
        return;
      }

      for (const f of data) {
        const div = document.createElement('div');
        div.className = 'bg-gray-700 p-4 rounded fade-in';
        div.innerHTML = `
          <h3 class="font-bold">${f.home} vs ${f.away} <span class="text-sm text-gray-400">[${f.type}]</span></h3>
          <p>${f.league} • ${new Date(f.date.seconds*1000).toLocaleString()}</p>
          <p>Odds: H ${f.odds.home} | D ${f.odds.draw} | A ${f.odds.away}</p>
          <p>Result: <strong>${f.result || '—'}</strong></p>
          <div class="mt-2 space-x-2">
            <button onclick="startEdit(${JSON.stringify(f).replace(/\"/g,'&quot;')})" class="bg-blue-500 px-3 py-1 rounded">Edit</button>
            <button onclick="deleteFixture('${f.id}')" class="bg-red-500 px-3 py-1 rounded">Delete</button>
          </div>`;
        fixturesList.appendChild(div);
      }
    }

    async function loadFixtures() {
      fixturesList.innerHTML = '<div class="spinner mx-auto"></div>';
      const snap = await getDocs(query(collection(db,'fixtures'), orderBy('date','asc')));
      allFixtures = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      renderFixtures();
    }

    onAuthStateChanged(auth, async user => {
      if (!user) return window.location.href = 'auth.html';
      const snap = await getDoc(doc(db,'users',user.uid));
      if (!snap.exists()||!snap.data().isAdmin) { await signOut(auth); return window.location.href='auth.html'; }
      adminUid = user.uid;
      updateNavbar(user);
      loadFixtures();
    });

    searchBox.addEventListener('input', renderFixtures);
    filterType.addEventListener('change', renderFixtures);
  </script>
</body>
</html>
